// -----------------------------------------------------------------
//	CONTRACT:  KSRTLA-Salvage2 - Deepsea Salvage - Deepsea Salvage - Rescue/Recover Meduim Wreck
//	Author: Caerfinon 
// -----------------------------------------------------------------

CONTRACT_TYPE
{
//CONTRACT DESCRIPTION
	sortKey = KSRTLA-SLVG-02
	name = KSRTLA-Salvage2
	title = Medium Aircraft Recovery
	group = Deepsea Salvage
	agent = Deepsea Salvage

	description = Steve Zissou Kerman of DeepSea Salvage needs our help. There has been a plane crash in @/crashBiome.FullName()! The pilot last reported they had suffered @/crashReason and had to put down in the water. He indicated they were sinking and then we lost contact. Send a rescue and recovery mission to the crash site to recover the seurvivors and salvage what you can.
	genericDescription =  A plane has crashed in the ocean and is sinking. Rescure the surviors and salvage what you can
	synopsis = Steve Zissou Kerman of DeepSea Salvage needs our help with a rescue mission involving underwater recovery.  
	notes = This mission requires that you rescue Kerbals from a sunken aircraft wreck and return the survivors to a seaport recovery loaction. There are optional salvage tasks.   
	completedMessage =  Fantastic! You have recovered the survivors from certain death in the crash at @/crashBiome.FullName(). &br;&br;Thanks!&br;-SZK 

//Contract Limits
	maxCompletions = 0 
	maxSimultaneous = 1
	autoAccept = false
	declinable = true
	cancellable = true
	minExpiry = 1.0
	maxExpiry = 1.0
	deadline = 0

//Contract Reward Modifiers
	prestige = Significant
	targetBody = Kerbin
	
//Contract Rewards
	advanceFunds = (@/rewardFunds * 0.25 )
	rewardFunds = 25000 * Random(1.0, 1.15)
	rewardReputation = 10.0
	rewardScience = 0.0

//Contract Penalties
	failureFunds = @/rewardFunds * Random(1.0, 1.15)
	failureReputation = 30.0
	

// REQUIREMENTS FOR CONTRACT TO APPEAR

// requires MK3 passenger
	REQUIREMENT
	{
		name = PartUnlocked
		type = PartUnlocked
		part = mk2CrewCabin
	}

	REQUIREMENT
	{
		name = CompleteContract
		type = CompleteContract
		contractType = KSRTLA-Salvage1
		minCount = 1
	}

// wait 30 days before offering another	
	REQUIREMENT
	{
		title = Cool down timer 21 days
		name = CompleteContract
		type = CompleteContract
		minCount = 0
		contractType =  KSRTLA-Salvage2
		cooldownDuration = 21d
	}

//DATA NODES TO PROCESS FOR CONTRACT USE

	DATA
	{
		type = String
		wreck = "MissingAircraft"
		craft = "KSRTLA-Salvage3"
		hidden = true
		
	}
	
	DATA
	{
		type = Waypoint
		hidden = true
		crashWaypoint = @/CrashWaypointGenerator.Waypoints().ElementAt(0)
	}

	DATA
	{
		type = Location
		hidden = true
		crashLocation = @/crashWaypoint.Location()
	}
	
	DATA
	{
		type = Biome
		hidden = true
		crashBiome = @/crashLocation.Biome()
	}
	
	DATA
	{
		type = List<string>
		hidden = true
		crashReasons = ["instrument failure","engine fire","structural damage","bird strikes","loss of power","depressurization"]
	}
	
	DATA
	{
		type = String
		hidden = true
		crashReason = @/crashReasons.Random()
	}
	
//Passenger Data

	DATA
	{
		type = List<Kerbal>
		kerbalsInDistress = NewKerbals(4)
		hidden = true
	}	


//BEHAVIOURS TO DO WHEN CREATING CONTRACT
// Waypoint to determine Crash zone
	BEHAVIOUR
	{
        name = CrashWaypointGenerator
        type = WaypointGenerator

		RANDOM_WAYPOINT
		{
			name = Crash Site
			targetBody = @/targetBody
			icon = ContractPacks/KerbinSideRemasteredTLA/Assets/Icons/salvage
			underwater = true 
			altitude = -0.1
		}
		
		WAYPOINT
		{
			name = @KSRTLA:HarbourFullName.ElementAt(0)
			targetBody = @/targetBody
			icon = ContractPacks/KerbinSideRemasteredTLA/Assets/Icons/port
			altitude = 0
			latitude = @KSRTLA:HarbourLAT.ElementAt(0)
			longitude = @KSRTLA:HarbourLON.ElementAt(0)
			parameter = RecoveryReady
		}
		WAYPOINT
		{
			name = @KSRTLA:HarbourFullName.ElementAt(1)
			targetBody = @/targetBody
			icon = ContractPacks/KerbinSideRemasteredTLA/Assets/Icons/port
			altitude = 0
			latitude = @KSRTLA:HarbourLAT.ElementAt(1)
			longitude = @KSRTLA:HarbourLON.ElementAt(1)
			parameter = RecoveryReady
		}
		WAYPOINT
		{
			name = @KSRTLA:HarbourFullName.ElementAt(2)
			targetBody = @/targetBody
			icon = ContractPacks/KerbinSideRemasteredTLA/Assets/Icons/port
			altitude = 0
			latitude = @KSRTLA:HarbourLAT.ElementAt(2)
			longitude = @KSRTLA:HarbourLON.ElementAt(2)
			parameter = RecoveryReady
		}
		WAYPOINT
		{
			name = @KSRTLA:HarbourFullName.ElementAt(3)
			targetBody = @/targetBody
			icon = ContractPacks/KerbinSideRemasteredTLA/Assets/Icons/port
			altitude = 0
			latitude = @KSRTLA:HarbourLAT.ElementAt(3)
			longitude = @KSRTLA:HarbourLON.ElementAt(3)
			parameter = RecoveryReady
		}
  		WAYPOINT
		{
			name = @KSRTLA:HarbourFullName.ElementAt(4)
			targetBody = @/targetBody
			icon = ContractPacks/KerbinSideRemasteredTLA/Assets/Icons/port 
			altitude = 0
			latitude = @KSRTLA:HarbourLAT.ElementAt(4)
			longitude = @KSRTLA:HarbourLON.ElementAt(4)
			parameter = RecoveryReady
		}
		WAYPOINT
		{
			name = @KSRTLA:HarbourFullName.ElementAt(5)
			targetBody = @/targetBody
			icon = ContractPacks/KerbinSideRemasteredTLA/Assets/Icons/port
			altitude = 0
			latitude = @KSRTLA:HarbourLAT.ElementAt(5)
			longitude = @KSRTLA:HarbourLON.ElementAt(5)
			parameter = RecoveryReady
		}
		WAYPOINT
		{
			name = @KSRTLA:HarbourFullName.ElementAt(6)
			targetBody = @/targetBody
			icon = ContractPacks/KerbinSideRemasteredTLA/Assets/Icons/port
			altitude = 0
			latitude = @KSRTLA:HarbourLAT.ElementAt(6)
			longitude = @KSRTLA:HarbourLON.ElementAt(6)
			parameter = RecoveryReady
		}
		
	}
//Set the missing plane at the Waypoint
	BEHAVIOUR
	{
		name = SpawnVessel
		type = SpawnVessel

		VESSEL
		{
			// Place wreck vessel on the at depth of 1 meter. It will sink within physics range 
			// If placed below the terrain level of the ocean floor it will fall through and explode
			name = @/wreck
			craftURL = ContractPacks/KerbinSideRemasteredTLA/Assets/Ships/MeduimWreck.craft
			flagURL = ContractPacks/KerbinSideRemasteredTLA/Assets/Flags/KSCAirlines
			vesselType = Unknown
			owned = false
			lat = @/crashLocation.Latitude()
			lon = @/crashLocation.Longitude()
			alt = -1
			
	        CREW
			{
				addToRoster = false
				name = @/kerbalsInDistress.ElementAt(0)
			}
	        CREW
			{
				addToRoster = false
				name = @/kerbalsInDistress.ElementAt(1)
			}
	        CREW
			{
				addToRoster = false
				name = @/kerbalsInDistress.ElementAt(2)
			}
	        CREW
			{
				addToRoster = false
				name = @/kerbalsInDistress.ElementAt(3)
			}
		}
	}

    BEHAVIOUR
    {
        type = ChangeKerbalType

        onState = CONTRACT_ACCEPTED

        KERBAL_INFO
        {
            kerbal = @/kerbalsInDistress.ElementAt(0)
            trait = Tourist
            kerbalType = Tourist
        }
        KERBAL_INFO
        {
            kerbal = @/kerbalsInDistress.ElementAt(1)
            trait = Tourist
            kerbalType = Tourist
        }
        KERBAL_INFO
        {
            kerbal = @/kerbalsInDistress.ElementAt(2)
            trait = Tourist
            kerbalType = Tourist
        }
        KERBAL_INFO
        {
            kerbal = @/kerbalsInDistress.ElementAt(3)
            trait = Tourist
            kerbalType = Tourist
        }
    }

//Remove the missing plane when the contract completes
	BEHAVIOUR
	{
		name = DestroyVessel
		type = DestroyVessel
		onState = CONTRACT_COMPLETED
		vessel = @/wreck
	}

//Remove the survivors when the contract completes
	BEHAVIOUR
	{
		name = RemoveKerbal
		type = RemoveKerbal
		kerbal = @/kerbalsInDistress
	}

// Mission Dialog boxes
	BEHAVIOUR
	{
		name = DialogBox
		type = DialogBox

		DIALOG_BOX
		{
			condition = PARAMETER_COMPLETED
			parameter = RecoveryReady
			position = CENTER
			
			TEXT
			{
				text = This is outstanding work! You've brought the survivors safely to the surface. I knew you could do it. Now bring them home to port... and if you happen to have any salvage, bring that too.  
				fontSize = 20
				textColor = #BADA55
			}
			
			IMAGE
			{
				url = ContractPacks/KerbinSideRemasteredTLA/Assets/Characters/SZ1
				characterName = Steve Zissou Kerman
			}
			
		}
		
		DIALOG_BOX
		{
			condition = PARAMETER_COMPLETED
			parameter = ReturnToPort
			
			position = CENTER
			
			TEXT
			{
				text = Trans Flight, we have you on approach. You are cleared for landing. On touchdown proceed to the indicated airport terminal. Directions have been transmited to you.
				fontSize = 20
				textColor = #BADA55
			}
			
			IMAGE
			{
				url = ContractPacks/KerbinSideRemasteredTLA/Assets/Characters/SZ2
				characterName = Steve Zissou Kerman
			}
			
		}
		
		
// failed misssion dialog
		DIALOG_BOX
		{
			condition = CONTRACT_FAILED
			position = CENTER
			title = <b>Sometimes Things Go Wrong</b>
			titleColor = #B00B1E
			
			TEXT
			{
				text = Trans Flight, Are you there? please respond. Trans Flight, we've lost you on radar, do you copy? Are you declaring an emergency?.... and you were doing so well.
				fontSize = 20
				textColor = #B00B1E
			}
			
			IMAGE
			{
				url = ContractPacks/KerbinSideRemasteredTLA/Assets/Characters/SZ3
				characterName = Steve Zissou Kerman
			}
		}
	}

// -----------------------------------------------------------------	
// RecoveryReady
// -----------------------------------------------------------------
	PARAMETER
	{
		name = RecoveryReady
		type = VesselParameterGroup
		define = @/craft
		title = Rescue the survivors at the crash site with your recovery vessel
		notes = The survivors are all tourists so you will need to dock with the wreck to transfer them. 
		completeInSequence = true
		disableOnStateChange = true
		hideVesselName = true
		
		PARAMETER
		{
			name = HasCrew
			type = HasCrew
			title = all survivors are on board
			hideChildren = true
			completeInSequence = true
			kerbal = @/kerbalsInDistress
		}
		PARAMETER
		{
			name = ReachState
			type = ReachState
			title = vessel is stopped on the surface 
			situation = SPLASHED
			maxSpeed = 5
			minAltitude = -5
			disableOnStateChange = false
			hideChildren = true
			completeInSequence = true
		}
	}
// -----------------------------------------------------------------	
// Return to port
// -----------------------------------------------------------------
	PARAMETER
	{
		name = ReturnToPort
		type = VesselParameterGroup
		vessel = @/craft
		title = Bring the surviors to a recovery location.
		completeInSequence = true
		disableOnStateChange = false
		hideVesselName = true	

		PARAMETER
		{
			name = Any
			type = Any
			title = return to any nearby seaport
			notes = Complete by navigating to a seaport within 500 meteres of the marker
			completeInSequence = true
			disableOnStateChange = true

			PARAMETER
			{
				name = VisitWaypoint
				type = VisitWaypoint
				title = @KSRTLA:HarbourFullName.ElementAt(0)
				index = 1
				distance = 500.0
				showMessages = true
				disableOnStateChange = false
				hideChildren = true
			}
			PARAMETER
			{
				name = VisitWaypoint
				type = VisitWaypoint
				title = @KSRTLA:HarbourFullName.ElementAt(1)
				index = 2
				distance = 500.0
				showMessages = true
				disableOnStateChange = false
				hideChildren = true
			}
			PARAMETER
			{
				name = VisitWaypoint
				type = VisitWaypoint
				title = @KSRTLA:HarbourFullName.ElementAt(2)
				index = 3
				distance = 500.0
				showMessages = true
				disableOnStateChange = false
				hideChildren = true
			}
			PARAMETER
			{
				name = VisitWaypoint
				type = VisitWaypoint
				title = @KSRTLA:HarbourFullName.ElementAt(3)
				index = 4
				distance = 500.0
				showMessages = true
				disableOnStateChange = false
				hideChildren = true
			}
			PARAMETER
			{
				name = VisitWaypoint
				type = VisitWaypoint
				title = @KSRTLA:HarbourFullName.ElementAt(4)
				index = 5
				distance = 500.0
				showMessages = true
				disableOnStateChange = false
				hideChildren = true
			}
			PARAMETER
			{
				name = VisitWaypoint
				type = VisitWaypoint
				title = @KSRTLA:HarbourFullName.ElementAt(5)
				index = 6
				distance = 500.0
				showMessages = true
				disableOnStateChange = false
				hideChildren = true
			}
			PARAMETER
			{
				name = VisitWaypoint
				type = VisitWaypoint
				title = @KSRTLA:HarbourFullName.ElementAt(6)
				index = 7
				distance = 500.0
				showMessages = true
				disableOnStateChange = false
				hideChildren = true
			}
		}
		PARAMETER
		{
			name = ReachState
			type = ReachState
			title = and stop your vessel on the surface
			situation = SPLASHED
			maxSpeed = 5
			minAltitude = -5
			disableOnStateChange = false
			hideChildren = true
			completeInSequence = true
		}
		PARAMETER
		{
			name = The Black Box
			type = PartValidation
			title = Recover the black box from the wreck's cockpit inventory (Optional)
			notes = Salvage: The black box cannot be detected in inventory. It must be attached to the recovery vessel. Before you return to a port
			rewardScience = 10.0
			rewardReputation = 2.0
			rewardFunds = 2500.0
			optional = true
			part = TheBlackBox
			maxCount = 1
			disableOnStateChange = false
			completedMessage = Excellent! This information in the flight recorder will be caulable in the crash incestigation.  
		}
		
		PARAMETER
		{
			name = Salvage The Wreck
			type = All
			title = have the wreck in tow at the port (Optional)
			notes = Salvage: To recover the wreck you need to dock/attach it to your recovery vessel before returning to port  
			rewardScience = 5.0
			rewardReputation = 5.0
			rewardFunds = 10000.0
			optional = true
			hideChildren = true
			completedMessage = Well done you! having the actual wreckage from the craft may help us find out what went wrong.

			PARAMETER
			{
				name = PartValidation
				type = PartValidation
				part = mk3Cockpit_Shuttle_wreck
				completeInSequence = true
				maxCount = 1
				disableOnStateChange = false
			}
			PARAMETER
			{
				name = PartValidation
				type = PartValidation
				part = mk3CrewCabin_wreck
				completeInSequence = true
				maxCount = 1
				disableOnStateChange = false
			}
		}
	}

// -----------------------------------------------------------------
// Safety first
// -----------------------------------------------------------------
	PARAMETER
	{
		name = KerbalDeaths
		type = KerbalDeaths
		title = Without killing anyone 
		vessel = @/craft
		hideChildren = true
		completeInSequence = true
	}
// -----------------------------------------------------------------
//Recovery Parameter - Recover Kerbals
// -----------------------------------------------------------------
	PARAMETER
	{
		name = RecoverKerbal
		type = RecoverKerbal
		title = and recover all survivors
		hideChildren = true
		completeInSequence = true
	}
}